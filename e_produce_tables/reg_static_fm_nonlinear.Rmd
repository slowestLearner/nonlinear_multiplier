---
author: ""
header-includes:
   - \usepackage{rotating}
   - \usepackage{float}
   - \usepackage{natbib}
   - \usepackage{booktabs}
   - \usepackage{multirow}
geometry: "left=1cm,right=1cm,top=0.9cm,bottom=1.2cm"
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: false
    number_sections: true
#bibliography: ref.bib
link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r, echo = FALSE, results = 'asis', warning=FALSE, message=FALSE}
rm(list = ls())
library(data.table)
library(dplyr)
library(tidyr)
library(scales)
library(xtable)
library(stringr)
library(pracma)
library(this.path)
setwd(this.path::this.dir())

# read data
data <- readRDS("../tmp/price_impact/regression_contemp/fm_nonlinear.RDS")[type != "OFI_pre_whitened"]

# select specifications
data <- data[var %in% c("ofi", "ofi_absofi")]
data <- data[spec_idx %in% 1:3]
data[, var_lab := ifelse(var == "ofi", "$d_{n,t}$", "$d_{n,t} \\times |d_{n,t}|$")]

# make easier to read
data[var != "ofi", coef := coef / 100]
data[var != "ofi", se := se / 100]

# rank the types
tmp <- unique(data[, .(type)])
tmp <- tmp[order(type)]
tmp[, type_idx := 1:3]
data <- merge(data, tmp, by = "type")
rm(tmp)
data[, idx := 10 * type_idx + spec_idx]

# add stars
cuts <- abs(qnorm(c(.01, .05, .1) / 2))
data[, abs_tstat := abs(coef / se)]
data[, ss := ifelse(abs_tstat > cuts[1], 3, ifelse(abs_tstat > cuts[2], 2, ifelse(abs_tstat > cuts[3], 1, 0)))]
data[, coef_lab := paste0("$", sprintf("%.2f", coef))]
data[, ss_lab := sapply(data[, ss], function(x) {
  ifelse(x > 0,
    paste0("^{", strcat(rep("*", x)), "}$"),
    "$"
  )
})]
data[, coef_lab := paste0(coef_lab, ss_lab)]
data[, ss_lab := NULL]

est <- dcast(data[, list(var_lab, idx, coef_lab)], var_lab ~ idx, value.var = "coef_lab") %>%
  dplyr::arrange(desc(var_lab)) %>%
  dplyr::mutate(group_id = 100 * row_number(), type = "coef")

se <- dcast(data[, list(var_lab, idx, se)], var_lab ~ idx, value.var = "se") %>%
  dplyr::arrange(desc(var_lab)) %>%
  dplyr::mutate_at(vars(2:ncol(.)), ~ paste0("$(", sprintf("%.2f", round(., 2)), ")$")) %>%
  dplyr::mutate(group_id = 100 * row_number() + 1, type = "se")

tbl <- bind_rows(est, se)
rm(est, se)

ctrls <- data.table(var_lab = "Predictor controls", t(rep(c("N", "Y", "Y"), 3)))
ctrls <- rbind(ctrls, data.table(var_lab = "Liquidity controls", t(rep(c("N", "N", "Y"), 3))))
ctrls[, group_id := 300 + 1:2]
ctrls[, type := ""]
names(ctrls) <- names(tbl)
tbl <- bind_rows(tbl, ctrls)
rm(ctrls)

obs_and_r2 <- unique(data[, list(idx, obs, r2, marginalr2 = r2 - r2_no_ofi)]) %>%
  mutate(
    obs = comma(obs),
    r2 = paste0("$", sprintf("%.3f", r2), "$"),
    marginalr2 = paste0("$", sprintf("%.3f", marginalr2), "$")
  ) %>%
  pivot_longer(., -idx) %>%
  pivot_wider(names_from = "idx", values_from = "value") %>%
  dplyr::mutate(name = replace(name, name == "r2", "$R^2$")) %>%
  dplyr::mutate(name = replace(name, name == "marginalr2", "Marginal $R^2(d_{n,t})$")) %>%
  mutate(name = replace(name, name == "obs", "Obs")) %>%
  rename(var_lab = name) %>%
  mutate(group_id = c(1001, 1002, 1003), type = "")

tbl <- bind_rows(tbl, obs_and_r2) %>%
  dplyr::arrange(group_id) %>%
  mutate(var_lab = ifelse(type == "se", "", var_lab)) %>%
  mutate(type = NULL, group_id = NULL)
rm(obs_and_r2)

names(tbl) <- as.character(1:ncol(tbl))

# add col columns
col_names <- data.table(t(as.data.frame(c("", paste0("(", 1:9, ")")))))
names(col_names) <- as.character(1:ncol(col_names))
tbl <- bind_rows(col_names, tbl)
rm(col_names)


align_vactor <- paste0("ll", paste0(rep("c", times = ncol(tbl) - 1), collapse = ""))
x.side <- xtable(tbl, align = align_vactor)

this_add_to_row <- list(
  pos = list(
    -1,
    0, 4, 6, 7, nrow(tbl)
  ),
  command = c(
    "\\hline & \\multicolumn{9}{c}{Dependent variable: stock return $r_{n,t}$} \\\\\n \\hline $d_{n,t}$ = & \\multicolumn{3}{c}{$\\Delta$ BMI} & \\multicolumn{3}{c}{FIT} & \\multicolumn{3}{c}{OFI} \\\\\n \\cmidrule(l){2-4} \\cmidrule(l){5-7} \\cmidrule(l){8-10}\n",
    rep("\\vspace{5pt}", 4),
    "\\hline \n"
  )
)

print(x.side,
  type = "latex",
  table.placement = "!ht",
  include.rownames = FALSE,
  include.colnames = FALSE,
  tabular.environment = "tabular",
  caption.placement = NULL, # "top", NULL
  hline.after = NULL, # We don't need hline; we use booktabs
  floating = FALSE, # whether \begin{Table} should be created (TRUE) or not (FALSE)
  sanitize.text.function = force, # Important to treat content of first column as latex function
  add.to.row = this_add_to_row
)

to_dir <- "../output/tables/"
dir.create(to_dir, showWarnings = F, recursive = T)
print(x.side,
  type = "latex",
  table.placement = "!ht",
  include.rownames = FALSE,
  include.colnames = FALSE,
  tabular.environment = "tabular",
  caption.placement = NULL, # "top", NULL
  hline.after = NULL, # We don't need hline; we use booktabs
  floating = FALSE, # whether \begin{Table} should be created (TRUE) or not (FALSE)
  sanitize.text.function = force, # Important to treat content of first column as latex function
  add.to.row = this_add_to_row,
  file = paste0(to_dir, "reg_static_fm_nonlinear.tex")
)
```