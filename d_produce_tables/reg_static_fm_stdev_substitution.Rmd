---
author: ""
header-includes:
   - \usepackage{rotating}
   - \usepackage{float}
   - \usepackage{natbib}
   - \usepackage{booktabs}
   - \usepackage{multirow}
geometry: "left=1cm,right=1cm,top=0.9cm,bottom=1.2cm"
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: false
    number_sections: true
link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r, echo = FALSE, results = 'asis', warning=FALSE, message=FALSE}
rm(list = ls())
library(data.table)
library(dplyr)
library(tidyr)
library(scales)
library(xtable)
library(stringr)
library(reshape2)
library(pracma)

# === panel A, regression results
data = readRDS('../tmp/price_impact/regression_contemp/fm_stdev_substitution.RDS')

# choose specification and variables
data[, type_idx := ifelse(type == 'BMI', 1, ifelse(type == 'FIT', 2, 3))]
data = data[grepl('ofi_bin', var)]

# variable names
data[, var_lab := var]
data[, var_lab := gsub('ofi_bin1', 'M_\\{\\|d_{n,t}| < \\\\sigma\\}', var_lab)]
data[, var_lab := gsub('ofi_bin2', 'M_\\{\\|d_{n,t}| \\\\in \\[\\\\sigma, 2\\\\sigma\\]\\}', var_lab)]
data[, var_lab := gsub('ofi_bin3', "M_\\{\\|d_{n,t}| > 2 \\\\sigma\\}", var_lab)]
data[, var_lab := paste0('$',var_lab,'$')]

# choose regression specifications
data = data[spec_idx %in% 3:5]
tmp = unique(data[, .(spec_idx, type_idx)])[order(type_idx, spec_idx)]
tmp[, reg_idx := 1:nrow(tmp)]
data = merge(data, tmp, by = c('type_idx','spec_idx'))[, spec_idx := NULL]; rm(tmp)

# = regression results
tmp = data[var %in% paste0('ofi_bin',1:3)]
tt = unique(tmp[, list(var)])
tt[, idx := 1:nrow(tt)]
tmp = merge(tmp, tt, by = 'var'); rm(tt)

# add stars to coefficients
cuts = abs(qnorm(c(.01, .05, .1)/2))
tmp[, abs_tstat := abs(coef/se)]
tmp[, ss := ifelse(abs_tstat > cuts[1], 3, ifelse(abs_tstat > cuts[2], 2, ifelse(abs_tstat > cuts[3], 1, 0)))]
tmp[, coef_lab := paste0('$',sprintf("%.2f", coef))]
tmp[, ss_lab := sapply(tmp[, ss], function(x){
  ifelse(x > 0, 
         paste0('^{',strcat(rep('*',x)),'}$'), 
         '$')})
]
tmp[, coef_lab := paste0(coef_lab, ss_lab)]
tmp[, ss_lab := NULL]

est <- dcast(tmp[, list(idx, reg_idx, coef_lab)], idx ~ reg_idx, value.var = 'coef_lab') %>% 
  dplyr::mutate(group_id = 100*row_number(), type = 'coef')

se <- dcast(tmp[, list(idx, reg_idx, se)], idx ~ reg_idx, value.var = 'se') %>% 
  dplyr::mutate(group_id = 100*row_number()+1, type = 'se') %>% 
  dplyr::mutate_at(vars(2:10), ~paste0('$(',sprintf("%.2f", round(.,2)),')$'))

var_labels = unique(tmp[, list(idx, var_lab)])

reg_tbl <- bind_rows(est, se) %>% 
  dplyr::inner_join(var_labels, by = 'idx') %>% 
  dplyr::mutate(idx = var_lab) %>% 
  dplyr::mutate(var_lab = NULL) %>% 
  dplyr::rename(var_lab = idx)
rm(est, se)

# note controls
ctrls = data.table(var_lab = 'Predictors', t(rep(c('Y','',''),3)))
ctrls = rbind(ctrls, data.table(var_lab = 'Liquidity', t(rep(c('Y','Y',''),3))))
ctrls = rbind(ctrls, data.table(var_lab = 'Predictors $\\times$ bin', t(rep(c('','Y','Y'),3))))
ctrls = rbind(ctrls, data.table(var_lab = 'Liquidity $\\times$ bin', t(rep(c('','','Y'),3))))
ctrls[, group_id := 300+1:nrow(ctrls)]
ctrls[, type := '']
names(ctrls) = names(reg_tbl)
reg_tbl <- bind_rows(reg_tbl, ctrls); rm(ctrls)

obs_and_r2 <- unique(data[, list(reg_idx, obs, r2, marginalr2 = r2 - r2_no_ofi)]) %>% 
  mutate(obs = comma(obs),
                r2 = paste0("$", sprintf("%.3f", r2), "$"),
                marginalr2 = paste0("$", sprintf("%.3f", marginalr2), "$")) %>% 
  pivot_longer(., -reg_idx) %>% 
  pivot_wider(names_from="reg_idx", values_from="value") %>% 
  dplyr::mutate(name = replace(name, name == "r2", "$R^2$")) %>%
  dplyr::mutate(name = replace(name, name == "marginalr2", "Marginal $R^2(d_{n,t})$")) %>% 
  mutate(name = replace(name, name == 'obs', 'Obs')) %>% 
  rename(var_lab = name) %>% 
  mutate(group_id = c(1001, 1002, 1003), type = '')

reg_tbl <- bind_rows(reg_tbl, obs_and_r2) %>% 
  dplyr::arrange(group_id) %>% 
  mutate(var_lab = ifelse(type == 'se', '', var_lab)) %>% 
  mutate(type = NULL, group_id = NULL)

# = add coef comparisions
tmp = copy(data[!(var %in% paste0('ofi_bin',1:3))])
tt = unique(tmp[, list(var_lab)])[order(var_lab)]
tt[, idx := c(3,2,1)]
tmp = merge(tmp, tt, by = 'var_lab')

# add stars
tmp[, abs_tstat := abs(coef/se)]
tmp[, ss := ifelse(abs_tstat > cuts[1], 3, ifelse(abs_tstat > cuts[2], 2, ifelse(abs_tstat > cuts[3], 1, 0)))]
tmp[, coef_lab := paste0('$',sprintf("%.2f", coef))]
tmp[, ss_lab := sapply(tmp[, ss], function(x){
  ifelse(x > 0, 
         paste0('^{',strcat(rep('*',x)),'}$'), 
         '$')})
]
tmp[, coef_lab := paste0(coef_lab, ss_lab)]
tmp[, ss_lab := NULL]

var_labels = unique(tmp[, list(idx, var_lab)]) # keep track of order

est <- dcast(tmp[, list(idx, reg_idx, coef_lab)], idx ~ reg_idx, value.var = 'coef_lab') %>% 
  dplyr::mutate(group_id = 100*row_number(), type = 'coef')

se <- dcast(tmp[, list(idx, reg_idx, se)], idx ~ reg_idx, value.var = 'se') %>% 
  dplyr::mutate(group_id = 100*row_number()+1, type = 'se') %>% 
  dplyr::mutate_at(vars(2:10), ~paste0('$(',sprintf("%.2f", round(.,2)),')$'))

comp_tbl <- bind_rows(est, se) %>% 
  dplyr::inner_join(var_labels, by = 'idx') %>% 
  dplyr::mutate(idx = var_lab) %>% 
  dplyr::mutate(var_lab = NULL) %>% 
  dplyr::rename(var_lab = idx) %>% 
  dplyr::arrange(group_id) %>% 
  dplyr::mutate(var_lab = ifelse(type == 'se', '', var_lab)) %>% 
  dplyr::mutate(group_id = NULL, type = NULL)

tbl_panelA <- bind_rows(reg_tbl, comp_tbl)
names(tbl_panelA) <- as.character(1:ncol(tbl_panelA))
rm(est, se, tt, tmp, obs_and_r2, reg_tbl, comp_tbl)

# add col columns
col_names <- data.table(t(as.data.frame(c('',paste0('(',1:9,')')))))
names(col_names) <- as.character(1:ncol(col_names))
tbl_panelA <- bind_rows(col_names, tbl_panelA); rm(col_names)
tbl <- copy(tbl_panelA)

align_vactor <- paste0("ll", paste0(rep("c", times = ncol(tbl) - 1), collapse = ""))
x.side <- xtable(tbl, align = align_vactor)

this_add_to_row <- list(pos = list(-1, 6, 10, 14, 20), 
                        command = c('\\hline \\multicolumn{10}{c}{Panel A: price impact regressions} \\\\\n \\hline 
                                    & \\multicolumn{9}{c}{Dependent variable: stock return $r_{n,t}$} \\\\\n
                                    \\cmidrule(l){2-10} & \\multicolumn{3}{c}{BMI} & \\multicolumn{3}{c}{FIT} & \\multicolumn{3}{c}{OFI} \\\\\n \\cmidrule(l){2-4} \\cmidrule(l){5-7} \\cmidrule(l){8-10} \n', 
                                    rep('\\vspace{5pt}', 2), 
                                    '\\hline \\multicolumn{10}{c}{Panel B: Coefficient differences} \\\\\n \\hline'
                        ,'\\hline \n'
                        ))

print(x.side, type = "latex", 
      table.placement = "!ht",
      include.rownames = FALSE,
      include.colnames = FALSE,
      tabular.environment = "tabular", 
          caption.placement = NULL, #"top", NULL
          hline.after=NULL, #We don't need hline; we use booktabs
          floating=FALSE, # whether \begin{Table} should be created (TRUE) or not (FALSE)
          sanitize.text.function = force, # Important to treat content of first column as latex function
      add.to.row = this_add_to_row
)


dir.create('../output/tables', showWarnings = F, recursive = T)
print(x.side, type = "latex", 
      table.placement = "!ht",
      include.rownames = FALSE,
      include.colnames = FALSE,
      tabular.environment = "tabular", 
          caption.placement = NULL, #"top", NULL
          hline.after=NULL, #We don't need hline; we use booktabs
          floating=FALSE, # whether \begin{Table} should be created (TRUE) or not (FALSE)
          sanitize.text.function = force, # Important to treat content of first column as latex function
      add.to.row = this_add_to_row
      ,file = '../output/tables/reg_static_fm_stdev_substitution.tex'
)





```